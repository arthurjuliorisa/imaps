// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// ENUMS
// ============================================================================

enum CustomsDocumentType {
  BC23 // Import Declaration
  BC27 // Other Bonded Zone Release (Incoming & Outgoing)
  BC40 // Local Purchase from Non-Bonded Zone
  BC30 // Export Declaration
  BC25 // Local Sales to Non-Bonded Zone
  BC261 // Subcontracting - Incoming
  BC262 // Subcontracting - Outgoing
}

// ============================================================================
// ITEM TYPE MASTER TABLE (Replaced ENUM for extensibility)
// ============================================================================

model item_types {
  item_type_code String   @id @db.VarChar(10)
  name_en        String   @db.VarChar(100)
  name_de        String?  @db.VarChar(100)
  name_id        String?  @db.VarChar(100)
  category       String   @db.VarChar(50)
  description    String?  @db.Text
  is_active      Boolean  @default(true)
  sort_order     Int?
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  updated_at     DateTime @updatedAt @db.Timestamptz(6)
}

enum AdjustmentType {
  GAIN // Inventory increase
  LOSS // Inventory decrease
}

enum Currency {
  USD
  IDR
  CNY
  EUR
  JPY
}

enum CompanyStatus {
  ACTIVE
  INACTIVE
}

enum CalculationMethod {
  TRANSACTION
  WIP_SNAPSHOT

  @@map("calculation_method")
}

// ============================================================================
// MASTER DATA TABLES
// ============================================================================

model companies {
  id         Int           @id @default(autoincrement())
  code       Int           @unique
  name       String        @db.VarChar(200)
  status     CompanyStatus @default(ACTIVE)
  created_at DateTime      @default(now()) @db.Timestamptz(6)
  updated_at DateTime      @updatedAt @db.Timestamptz(6)
  deleted_at DateTime?     @db.Timestamptz(6)

  // Relations
  incoming_goods               incoming_goods[]
  material_usages              material_usages[]
  wip_balances                 wip_balances[]
  production_outputs           production_outputs[]
  outgoing_goods               outgoing_goods[]
  adjustments                  adjustments[]
  beginning_balances           beginning_balances[]
  scrap_items                  scrap_items[]
  items                        items[]
  users                        users[]
  snapshot_recalc_queue        snapshot_recalc_queue[]
  stock_daily_snapshot         stock_daily_snapshot[]
  scrap_transactions           scrap_transactions[]

  @@index([code])
  @@index([status])
}

model items {
  id           Int       @id @default(autoincrement())
  company_code Int
  item_code    String    @db.VarChar(50)
  item_name    String    @db.VarChar(200)
  item_type    String    @db.VarChar(10)
  hs_code      String?   @db.VarChar(20)
  uom          String    @db.VarChar(20)
  currency     Currency  @default(USD)
  is_active    Boolean   @default(true)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at   DateTime? @db.Timestamptz(6)

  company companies @relation(fields: [company_code], references: [code])

  @@unique([company_code, item_code])
  @@index([company_code])
  @@index([item_code])
  @@index([item_type])
  @@index([is_active])
}

model users {
  id           String    @id @default(dbgenerated("gen_random_uuid()"))
  username     String    @unique @db.VarChar(100)
  email        String    @unique @db.VarChar(200)
  password     String    @db.VarChar(255)
  full_name    String    @db.VarChar(200)
  role         String    @default("USER") @db.VarChar(50)
  company_code Int?
  is_active    Boolean   @default(true)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at   DateTime? @db.Timestamptz(6)

  // Relations
  company           companies?          @relation(fields: [company_code], references: [code], onDelete: NoAction, onUpdate: NoAction)
  user_access_menus user_access_menus[]

  @@index([username])
  @@index([email])
  @@index([company_code])
}

model menus {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  parent_id  String?
  menu_name  String   @db.VarChar(100)
  menu_path  String?  @db.VarChar(255)
  menu_icon  String?  @db.VarChar(50)
  menu_order Int?
  is_active  Boolean  @default(true)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  parent            menus?              @relation("MenuHierarchy", fields: [parent_id], references: [id], onDelete: NoAction, onUpdate: NoAction)
  children          menus[]             @relation("MenuHierarchy")
  user_access_menus user_access_menus[]

  @@index([parent_id])
  @@index([menu_order])
}

model user_access_menus {
  id         String   @id @default(dbgenerated("gen_random_uuid()"))
  user_id    String
  menu_id    String
  can_view   Boolean  @default(true)
  can_create Boolean  @default(false)
  can_edit   Boolean  @default(false)
  can_delete Boolean  @default(false)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  updated_at DateTime @updatedAt @db.Timestamptz(6)

  // Relations
  user users @relation(fields: [user_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  menu menus @relation(fields: [menu_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([user_id, menu_id])
  @@index([user_id])
  @@index([menu_id])
}

model beginning_balances {
  id           Int       @id @default(autoincrement())
  company_code Int
  item_code    String    @db.VarChar(50)
  item_name    String    @db.VarChar(200)
  item_type    String    @db.VarChar(10)
  uom          String    @db.VarChar(20)
  qty          Decimal   @db.Decimal(15, 3)
  balance_date DateTime  @db.Date
  remarks      String?   @db.VarChar(1000)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at   DateTime? @db.Timestamptz(6)

  company companies @relation(fields: [company_code], references: [code])
  ppkeks      beginning_balance_ppkeks[]

  @@unique([company_code, item_code, balance_date])
  @@index([company_code])
  @@index([item_code])
  @@index([balance_date])
}

model beginning_balance_ppkeks {
  id                    Int                @id @default(autoincrement())
  beginning_balance_id  Int
  ppkek_number          String             @db.VarChar(50)
  created_at            DateTime           @default(now()) @db.Timestamptz(6)

  beginning_balance beginning_balances @relation(fields: [beginning_balance_id], references: [id], onDelete: Cascade)

  @@unique([beginning_balance_id, ppkek_number])
  @@index([beginning_balance_id])
  @@index([ppkek_number])
}

// ============================================================================
// SCRAP MASTER DATA
// ============================================================================

model scrap_items {
  id                Int       @id @default(autoincrement())
  company_code      Int
  scrap_code        String    @unique @db.VarChar(50)
  scrap_name        String    @db.VarChar(200)
  scrap_description String?   @db.VarChar(500)
  uom               String    @db.VarChar(20)
  is_active         Boolean   @default(true)
  created_at        DateTime  @default(now()) @db.Timestamptz(6)
  updated_at        DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at        DateTime? @db.Timestamptz(6)

  company            companies            @relation(fields: [company_code], references: [code])
  scrap_item_details scrap_item_details[]

  @@unique([company_code, scrap_code])
  @@index([company_code])
  @@index([scrap_code])
  @@index([is_active])
}

model scrap_item_details {
  id             Int      @id @default(autoincrement())
  scrap_item_id  Int
  component_code String   @db.VarChar(50)
  component_name String   @db.VarChar(200)
  component_type String   @db.VarChar(10)
  uom            String   @db.VarChar(20)
  quantity       Decimal  @db.Decimal(15, 3)
  percentage     Decimal? @db.Decimal(5, 2)
  remarks        String?  @db.VarChar(500)
  created_at     DateTime @default(now()) @db.Timestamptz(6)
  updated_at     DateTime @updatedAt @db.Timestamptz(6)

  scrap_item scrap_items @relation(fields: [scrap_item_id], references: [id], onDelete: Cascade)

  @@unique([scrap_item_id, component_code])
  @@index([scrap_item_id])
  @@index([component_code])
}

model audit_logs {
  id         BigInt   @id @default(autoincrement())
  table_name String   @db.VarChar(100)
  record_id  Int
  action     String   @db.VarChar(20)
  old_values Json?
  new_values Json?
  changed_by String?  @db.VarChar(100)
  changed_at DateTime @default(now()) @db.Timestamptz(6)
  ip_address String?  @db.VarChar(50)
  user_agent String?  @db.VarChar(500)

  @@index([table_name])
  @@index([record_id])
  @@index([action])
  @@index([changed_at])
}

// ============================================================================
// PARTITIONED TABLES
// Note: Prisma will create these as regular tables first
// Then setup_partitions.sql will convert them to partitioned tables
// ============================================================================

// ============================================================================
// INCOMING GOODS - PARTITIONED TABLE
// ============================================================================
// IMPORTANT: FK relation removed because PostgreSQL doesn't support
// foreign keys from regular tables to partitioned tables.
// Referential integrity is maintained at application level.
// ============================================================================

model incoming_goods {
  id                        Int                 @id @default(autoincrement())
  wms_id                    String              @db.VarChar(100)
  company_code              Int
  owner                     Int
  customs_document_type     CustomsDocumentType
  ppkek_number              String              @db.VarChar(50)
  customs_registration_date DateTime            @db.Date
  incoming_evidence_number  String              @db.VarChar(50)
  incoming_date             DateTime            @db.Date
  invoice_number            String              @db.VarChar(50)
  invoice_date              DateTime            @db.Date
  shipper_name              String              @db.VarChar(200)
  timestamp                 DateTime            @db.Timestamptz(6)
  created_at                DateTime            @default(now()) @db.Timestamptz(6)
  updated_at                DateTime            @updatedAt @db.Timestamptz(6)
  deleted_at                DateTime?           @db.Timestamptz(6)

  company companies @relation(fields: [company_code], references: [code])
  // NOTE: items relation removed - use manual joins in queries
  // items   incoming_good_items[]

  @@unique([company_code, wms_id, incoming_date])
  @@unique([company_code, id, incoming_date])
  @@index([wms_id])
  @@index([company_code])
  @@index([incoming_date])
  @@index([ppkek_number])
  @@index([customs_document_type])
  @@index([incoming_evidence_number])
}

model incoming_good_items {
  id                    Int       @id @default(autoincrement())
  incoming_good_id      Int
  incoming_good_company Int
  incoming_good_date    DateTime  @db.Date
  item_type             String    @db.VarChar(10)
  item_code             String    @db.VarChar(50)
  item_name             String    @db.VarChar(200)
  hs_code               String?   @db.VarChar(20)
  uom                   String    @db.VarChar(20)
  qty                   Decimal   @db.Decimal(15, 3)
  currency              Currency
  amount                Decimal   @db.Decimal(18, 4)
  created_at            DateTime  @default(now()) @db.Timestamptz(6)
  updated_at            DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at            DateTime? @db.Timestamptz(6)

  // NOTE: incoming_good relation removed due to partitioning limitation
  // PostgreSQL doesn't support FK from regular table to partitioned table
  // Use manual joins: WHERE incoming_good_company = ? AND incoming_good_id = ? AND incoming_good_date = ?
  // incoming_good incoming_goods @relation(fields: [incoming_good_company, incoming_good_id, incoming_good_date], references: [company_code, id, incoming_date], onDelete: Cascade)

  @@index([incoming_good_id])
  @@index([incoming_good_id, incoming_good_company, incoming_good_date])
  @@index([item_code])
  @@index([item_type])
}

model material_usages {
  id                       Int       @id @default(autoincrement())
  wms_id                   String    @db.VarChar(100)
  company_code             Int
  work_order_number        String?   @db.VarChar(50)
  cost_center_number       String?
  internal_evidence_number String    @db.VarChar(50)
  transaction_date         DateTime  @db.Date
  reversal                 String?   @db.VarChar(1)
  timestamp                DateTime  @db.Timestamptz(6)
  created_at               DateTime  @default(now()) @db.Timestamptz(6)
  updated_at               DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at               DateTime? @db.Timestamptz(6)

  company                         companies                         @relation(fields: [company_code], references: [code])
  items                           material_usage_items[]
  work_order_material_consumption work_order_material_consumption[]

  @@unique([company_code, wms_id, transaction_date])
  @@unique([company_code, id, transaction_date])
  @@index([wms_id])
  @@index([company_code])
  @@index([transaction_date])
  @@index([work_order_number])
  @@index([cost_center_number])
  @@index([internal_evidence_number])
}

model material_usage_items {
  id                     Int       @id @default(autoincrement())
  material_usage_id      Int
  material_usage_company Int
  material_usage_date    DateTime  @db.Date
  item_type              String    @db.VarChar(10)
  item_code              String    @db.VarChar(50)
  item_name              String    @db.VarChar(200)
  uom                    String    @db.VarChar(20)
  qty                    Decimal   @db.Decimal(15, 3)
  ppkek_number           String?   @db.VarChar(50)
  created_at             DateTime  @default(now()) @db.Timestamptz(6)
  updated_at             DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at             DateTime? @db.Timestamptz(6)

  material_usage material_usages @relation(fields: [material_usage_company, material_usage_id, material_usage_date], references: [company_code, id, transaction_date], onDelete: Cascade)

  @@index([material_usage_id])
  @@index([material_usage_id, material_usage_company, material_usage_date])
  @@index([item_code])
  @@index([item_type])
  @@index([ppkek_number])
}

model wip_balances {
  id           Int       @id @default(autoincrement())
  wms_id       String    @db.VarChar(100)
  company_code Int
  item_type    String    @db.VarChar(10)
  item_code    String    @db.VarChar(50)
  item_name    String    @db.VarChar(200)
  stock_date   DateTime  @db.Date
  uom          String    @db.VarChar(20)
  qty          Decimal   @db.Decimal(15, 3)
  timestamp    DateTime  @db.Timestamptz(6)
  created_at   DateTime  @default(now()) @db.Timestamptz(6)
  updated_at   DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at   DateTime? @db.Timestamptz(6)

  company companies @relation(fields: [company_code], references: [code])

  @@unique([company_code, wms_id, stock_date])
  @@index([wms_id])
  @@index([company_code])
  @@index([stock_date])
  @@index([item_code])
  @@index([item_type])
}

model production_outputs {
  id                       Int       @id @default(autoincrement())
  wms_id                   String    @db.VarChar(100)
  company_code             Int
  internal_evidence_number String    @db.VarChar(50)
  transaction_date         DateTime  @db.Date
  reversal                 String?   @db.VarChar(1)
  timestamp                DateTime  @db.Timestamptz(6)
  created_at               DateTime  @default(now()) @db.Timestamptz(6)
  updated_at               DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at               DateTime? @db.Timestamptz(6)

  company                  companies                  @relation(fields: [company_code], references: [code])
  items                    production_output_items[]
  work_order_fg_production work_order_fg_production[]

  @@unique([company_code, wms_id, transaction_date])
  @@unique([company_code, id, transaction_date])
  @@index([wms_id])
  @@index([company_code])
  @@index([transaction_date])
  @@index([internal_evidence_number])
}

model production_output_items {
  id                        Int       @id @default(autoincrement())
  production_output_id      Int
  production_output_company Int
  production_output_date    DateTime  @db.Date
  item_type                 String    @db.VarChar(10)
  item_code                 String    @db.VarChar(50)
  item_name                 String    @db.VarChar(200)
  uom                       String    @db.VarChar(20)
  qty                       Decimal   @db.Decimal(15, 3)
  work_order_numbers        String[]
  created_at                DateTime  @default(now()) @db.Timestamptz(6)
  updated_at                DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at                DateTime? @db.Timestamptz(6)

  production_output production_outputs @relation(fields: [production_output_company, production_output_id, production_output_date], references: [company_code, id, transaction_date], onDelete: Cascade)

  @@index([production_output_id])
  @@index([production_output_id, production_output_company, production_output_date])
  @@index([item_code])
  @@index([item_type])
}

model outgoing_goods {
  id                        Int                 @id @default(autoincrement())
  wms_id                    String              @db.VarChar(100)
  company_code              Int
  owner                     Int
  customs_document_type     CustomsDocumentType
  ppkek_number              String              @db.VarChar(50)
  customs_registration_date DateTime            @db.Date
  outgoing_evidence_number  String              @db.VarChar(50)
  outgoing_date             DateTime            @db.Date
  invoice_number            String              @db.VarChar(50)
  invoice_date              DateTime            @db.Date
  recipient_name            String              @db.VarChar(200)
  timestamp                 DateTime            @db.Timestamptz(6)
  created_at                DateTime            @default(now()) @db.Timestamptz(6)
  updated_at                DateTime            @updatedAt @db.Timestamptz(6)
  deleted_at                DateTime?           @db.Timestamptz(6)

  company companies             @relation(fields: [company_code], references: [code])
  items   outgoing_good_items[]

  @@unique([company_code, wms_id, outgoing_date])
  @@unique([company_code, id, outgoing_date])
  @@index([wms_id])
  @@index([company_code])
  @@index([outgoing_date])
  @@index([ppkek_number])
  @@index([customs_document_type])
  @@index([outgoing_evidence_number])
}

model outgoing_good_items {
  id                        Int       @id @default(autoincrement())
  outgoing_good_id          Int
  outgoing_good_company     Int
  outgoing_good_date        DateTime  @db.Date
  item_type                 String    @db.VarChar(10)
  item_code                 String    @db.VarChar(50)
  item_name                 String    @db.VarChar(200)
  production_output_wms_ids String[]
  incoming_ppkek_numbers    String[]  @default([])
  hs_code                   String?   @db.VarChar(20)
  uom                       String    @db.VarChar(20)
  qty                       Decimal   @db.Decimal(15, 3)
  currency                  Currency
  amount                    Decimal   @db.Decimal(18, 4)
  created_at                DateTime  @default(now()) @db.Timestamptz(6)
  updated_at                DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at                DateTime? @db.Timestamptz(6)

  outgoing_good                       outgoing_goods                        @relation(fields: [outgoing_good_company, outgoing_good_id, outgoing_good_date], references: [company_code, id, outgoing_date], onDelete: Cascade)
  outgoing_fg_production_traceability outgoing_fg_production_traceability[]

  @@index([outgoing_good_id])
  @@index([outgoing_good_id, outgoing_good_company, outgoing_good_date])
  @@index([item_code])
  @@index([item_type])
}

model adjustments {
  id                       Int       @default(autoincrement())
  wms_id                   String    @db.VarChar(100)
  company_code             Int
  wms_doc_type             String?   @db.VarChar(100)
  internal_evidence_number String    @db.VarChar(50)
  transaction_date         DateTime  @db.Date
  timestamp                DateTime  @db.Timestamptz(6)
  created_at               DateTime  @default(now()) @db.Timestamptz(6)
  updated_at               DateTime  @updatedAt @db.Timestamptz(6)
  deleted_at               DateTime? @db.Timestamptz(6)

  company companies          @relation(fields: [company_code], references: [code])
  items   adjustment_items[]

  @@unique([company_code, wms_id, transaction_date])
  @@unique([company_code, id, transaction_date])
  @@index([wms_id])
  @@index([company_code])
  @@index([transaction_date])
  @@index([internal_evidence_number])
}

model adjustment_items {
  id                 Int            @id @default(autoincrement())
  adjustment_id      Int
  adjustment_company Int
  adjustment_date    DateTime       @db.Date
  adjustment_type    AdjustmentType
  item_type          String         @db.VarChar(10)
  item_code          String         @db.VarChar(50)
  item_name          String         @db.VarChar(200)
  uom                String         @db.VarChar(20)
  qty                Decimal        @db.Decimal(15, 3)
  reason             String?        @db.VarChar(500)
  created_at         DateTime       @default(now()) @db.Timestamptz(6)
  updated_at         DateTime       @updatedAt @db.Timestamptz(6)
  deleted_at         DateTime?      @db.Timestamptz(6)

  adjustment adjustments @relation(fields: [adjustment_company, adjustment_id, adjustment_date], references: [company_code, id, transaction_date], onDelete: Cascade)

  @@index([adjustment_id])
  @@index([adjustment_id, adjustment_company, adjustment_date])
  @@index([item_code])
  @@index([item_type])
  @@index([adjustment_type])
}

// ============================================================================
// CAPITAL GOODS TRANSACTIONS
// ============================================================================
// These tables handle incoming capital goods purchases and outgoing scrap disposals
// Capital goods are identified by item_type: HIBE_M, HIBE_E, HIBE_T
// ============================================================================

// ============================================================================
// SCRAP TRANSACTIONS
// ============================================================================

model scrap_transactions {
  id                        Int                       @id @default(autoincrement())
  company_code              Int
  transaction_date          DateTime                  @db.Date
  transaction_type          String                    @db.VarChar(10) // 'IN' or 'OUT'
  document_number           String                    @db.VarChar(100)
  source                    String?                   @db.VarChar(200) // For IN transactions
  recipient_name            String?                   @db.VarChar(200) // For OUT transactions
  disposal_method           String?                   @db.VarChar(100) // For OUT: "Sold as scrap", "Destroyed", "Donated"
  remarks                   String?                   @db.VarChar(1000)
  ppkek_number              String?                   @db.VarChar(50) // Customs registration number (for OUT transactions)
  customs_registration_date DateTime?                 @db.Date // Customs registration date (for OUT transactions)
  customs_document_type     String?                   @db.VarChar(10) // BC25, BC27, BC41 (for OUT transactions)
  timestamp                 DateTime                  @default(now()) @db.Timestamptz(6)
  created_at                DateTime                  @default(now()) @db.Timestamptz(6)
  updated_at                DateTime                  @updatedAt @db.Timestamptz(6)
  deleted_at                DateTime?                 @db.Timestamptz(6)

  company companies                   @relation(fields: [company_code], references: [code])
  items   scrap_transaction_items[]

  @@unique([company_code, id, transaction_date])
  @@index([company_code])
  @@index([transaction_date])
  @@index([document_number])
  @@index([transaction_type])
}

model scrap_transaction_items {
  id                     Int                @id @default(autoincrement())
  scrap_transaction_id   Int
  scrap_transaction_company Int
  scrap_transaction_date DateTime           @db.Date
  item_type              String             @default("SCRAP") @db.VarChar(10)
  item_code              String             @db.VarChar(50)
  item_name              String             @db.VarChar(200)
  uom                    String             @db.VarChar(20)
  qty                    Decimal            @db.Decimal(15, 3)
  currency               Currency
  amount                 Decimal            @db.Decimal(18, 4)
  scrap_reason           String?            @db.VarChar(500)
  remarks                String?            @db.VarChar(500)
  created_at             DateTime           @default(now()) @db.Timestamptz(6)
  updated_at             DateTime           @updatedAt @db.Timestamptz(6)
  deleted_at             DateTime?          @db.Timestamptz(6)

  scrap_transaction scrap_transactions @relation(fields: [scrap_transaction_company, scrap_transaction_id, scrap_transaction_date], references: [company_code, id, transaction_date], onDelete: Cascade)

  @@index([scrap_transaction_id])
  @@index([scrap_transaction_id, scrap_transaction_company, scrap_transaction_date])
  @@index([item_code])
  @@index([item_type])
}

// ============================================================================
// TRACEABILITY TABLES
// ============================================================================

model work_order_material_consumption {
  id                     BigInt   @id @default(autoincrement())
  material_usage_id      Int
  material_usage_item_id Int
  material_usage_wms_id  String   @db.VarChar(100)
  work_order_number      String   @db.VarChar(50)
  company_code           Int
  item_code              String   @db.VarChar(50)
  ppkek_number           String?  @db.VarChar(50) // Nullable: materials from adjustments may not have PPKEK
  qty_consumed           Decimal  @db.Decimal(15, 3)
  trx_date               DateTime @db.Date
  created_at             DateTime @default(now()) @db.Timestamptz(6)

  material_usage material_usages @relation(fields: [material_usage_id], references: [id], onDelete: Cascade)

  @@unique([material_usage_wms_id, work_order_number, item_code])
  @@index([work_order_number])
  @@index([company_code])
  @@index([ppkek_number])
  @@index([trx_date])
}

model work_order_fg_production {
  id                        BigInt   @id @default(autoincrement())
  production_output_id      Int
  production_output_item_id Int
  production_wms_id         String   @db.VarChar(100)
  work_order_number         String   @db.VarChar(50)
  company_code              Int
  item_type                 String   @db.VarChar(10) // FERT or HALB
  item_code                 String   @db.VarChar(50)
  qty_produced              Decimal  @db.Decimal(15, 3)
  trx_date                  DateTime @db.Date
  created_at                DateTime @default(now()) @db.Timestamptz(6)

  production_output production_outputs @relation(fields: [production_output_id], references: [id], onDelete: Cascade)

  @@unique([production_wms_id, work_order_number, item_code], name: "work_order_fg_production_unique")
  @@index([work_order_number])
  @@index([company_code])
  @@index([item_type])
  @@index([trx_date])
}

model outgoing_fg_production_traceability {
  id                    BigInt   @id @default(autoincrement())
  outgoing_good_item_id Int
  outgoing_wms_id       String   @db.VarChar(100)
  production_wms_id     String   @db.VarChar(100)
  company_code          Int
  item_code             String   @db.VarChar(50)
  trx_date              DateTime @db.Date
  allocated_qty         Decimal? @db.Decimal(15, 3) // Nullable: Optional qty allocation
  allocation_notes      String?  @db.Text
  created_at            DateTime @default(now()) @db.Timestamptz(6)
  updated_at            DateTime @updatedAt @db.Timestamptz(6)

  outgoing_good_item outgoing_good_items @relation(fields: [outgoing_good_item_id], references: [id], onDelete: Cascade)

  @@unique([outgoing_wms_id, production_wms_id, item_code])
  @@index([outgoing_wms_id])
  @@index([production_wms_id])
  @@index([company_code])
  @@index([trx_date])
}

model stock_daily_snapshot {
  id                 BigInt            @id @default(autoincrement())
  company_code       Int
  item_type          String            @db.VarChar(10)
  item_code          String            @db.VarChar(50)
  item_name          String            @db.VarChar(200)
  uom                String            @db.VarChar(20)
  opening_balance    Decimal           @default(0) @db.Decimal(15, 3)
  closing_balance    Decimal           @default(0) @db.Decimal(15, 3)
  incoming_qty       Decimal           @default(0) @db.Decimal(15, 3)
  outgoing_qty       Decimal           @default(0) @db.Decimal(15, 3)
  production_qty     Decimal           @default(0) @db.Decimal(15, 3)
  material_usage_qty Decimal           @default(0) @db.Decimal(15, 3)
  adjustment_qty     Decimal           @default(0) @db.Decimal(15, 3) // Can be positive (GAIN) or negative (LOSS)
  wip_balance_qty    Decimal?          @db.Decimal(15, 3) // For HALB only (snapshot-based)
  snapshot_date      DateTime          @db.Date
  calculated_at      DateTime          @default(now()) @db.Timestamptz(6)
  calculation_method CalculationMethod
  created_at         DateTime          @default(now()) @db.Timestamptz(6)
  updated_at         DateTime          @updatedAt @db.Timestamptz(6)

  company companies @relation(fields: [company_code], references: [code], onDelete: Cascade)

  @@unique([company_code, item_type, item_code, snapshot_date])
  @@index([company_code, snapshot_date])
  @@index([item_type, snapshot_date])
  @@index([snapshot_date])
}

// ============================================================================
// SNAPSHOT RECALCULATION QUEUE
// ============================================================================

enum RecalcStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  FAILED

  @@map("recalc_status")
}

model snapshot_recalc_queue {
  id            BigInt       @id @default(autoincrement())
  company_code  Int
  item_type     String?      @db.VarChar(10)
  item_code     String?      @db.VarChar(50)
  recalc_date   DateTime     @db.Date
  status        RecalcStatus @default(PENDING)
  priority      Int          @default(0)
  reason        String?      @db.VarChar(500)
  queued_at     DateTime     @default(now()) @db.Timestamptz(6)
  started_at    DateTime?    @db.Timestamptz(6)
  completed_at  DateTime?    @db.Timestamptz(6)
  error_message String?      @db.Text

  company companies @relation(fields: [company_code], references: [code], onDelete: Cascade)

  @@unique([company_code, recalc_date, item_type, item_code])
  @@index([status, priority, queued_at])
  @@index([company_code, recalc_date])
}
